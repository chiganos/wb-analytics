import sqlite3
import pandas as pd
from fastapi.responses import HTMLResponse
import plotly.graph_objects as go
import numpy as np

def analyze_keywords(db_path: str, article: str):
    conn = sqlite3.connect(db_path)
    positions = pd.read_sql("SELECT * FROM positions WHERE article = ?", conn, params=(article,))
    funnel = pd.read_sql("SELECT * FROM funnel WHERE article = ?", conn, params=(article,))
    conn.close()

    if positions.empty or funnel.empty:
        return HTMLResponse("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö.</p>")

    positions["date"] = pd.to_datetime(positions["date"])
    funnel["date"] = pd.to_datetime(funnel["date"])

    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –¥–ª—è open_card
    pos_grouped = positions.groupby(["date", "search_query"]).agg({"open_card": "sum"}).reset_index()
    funnel_grouped = funnel.groupby("date").agg({"cart_add": "sum"}).reset_index()

    merged = pd.merge(pos_grouped, funnel_grouped, on="date", how="inner")

    # –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ —Å >100 –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ
    total_open = merged.groupby("search_query")["open_card"].sum().reset_index()
    total_open = total_open[total_open["open_card"] > 100]
    filtered = merged[merged["search_query"].isin(total_open["search_query"])]

    if filtered.empty:
        return HTMLResponse("<p>‚ö†Ô∏è –ù–µ—Ç –∫–ª—é—á–µ–π —Å >100 –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏</p>")

    correlations = filtered.groupby("search_query").apply(
        lambda g: g["open_card"].corr(g["cart_add"])
    ).reset_index(name="correlation")

    # –î–æ–±–∞–≤–∏–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    total_transitions = filtered.groupby("search_query")["open_card"].sum().reset_index()
    result = pd.merge(correlations, total_transitions, on="search_query")
    result = result.dropna().sort_values("open_card", ascending=False).head(20)

    fig = go.Figure()
    fig.add_trace(go.Bar(
        x=result["search_query"],
        y=result["open_card"],
        name="–ü–µ—Ä–µ—Ö–æ–¥—ã",
        marker_color="orange"
    ))
    fig.add_trace(go.Scatter(
        x=result["search_query"],
        y=result["correlation"],
        name="–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è",
        mode="lines+markers",
        yaxis="y2",
        line=dict(color="green")
    ))

    fig.update_layout(
        title=f"–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ / –∞—Ä—Ç–∏–∫—É–ª {article}",
        xaxis_title="–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ",
        yaxis=dict(title="–ü–µ—Ä–µ—Ö–æ–¥—ã"),
        yaxis2=dict(title="–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è", overlaying="y", side="right", showgrid=False, range=[-1, 1]),
        legend=dict(x=0.01, y=0.99),
        hovermode="x unified"
    )

    top_keyword = result.sort_values("correlation", ascending=False).iloc[0]["search_query"]
    html_top = f"<p>üîç <b>–°–∞–º–æ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ</b>: {top_keyword}</p>"

    return HTMLResponse(content=html_top + fig.to_html(full_html=False, include_plotlyjs='cdn'))
